<!--
    Custom Django Admin Change Form Template

    This template customizes the appearance and functionality of the change form
    used in the Django admin interface for editing model instances. It extends
    the default "admin/base_site.html" and adds:

    - A custom breadcrumb navigation path.
    - Inclusion of static admin CSS and JavaScript.
    - Rendering of form fields, errors, and inline formsets.
    - A custom "Open Researcher" button if a `researcher_link` is provided.
    - Optional support for file uploads and popup windows.
    - Dynamic JS inclusion for prepopulated fields and form behaviors.

    Context variables expected:
    - opts: model options (app label, model name, verbose names)
    - adminform: form object including form fields and errors
    - inline_admin_formsets: inline related forms
    - change, add: booleans indicating editing or adding mode
    - errors: form validation errors
    - researcher_link: optional URL to open related researcher view
    - has_file_field: boolean if form includes file uploads
    - is_popup: boolean for popup mode
    - form_url: optional form action URL

    Place this template in your appâ€™s "templates/admin/[app_label]/[model_name]/change_form.html"
    to override the default admin change form for a specific model.
-->

{# Base template #}
{% extends "admin/base_site.html" %}

{# Static template tags #}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<script src="{% url 'admin:jsi18n' %}"></script>
{{ media }}
{% endblock %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" href="{% static "admin/css/forms.css" %}">{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; {% if has_view_permission %}<a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>{% else %}{{ opts.verbose_name_plural|capfirst }}{% endif %}
&rsaquo; {% if add %}{% blocktranslate with name=opts.verbose_name %}Add {{ name }}{% endblocktranslate %}{% else %}{{ original|truncatewords:"18" }}{% endif %}
</div>
{% endblock %}
{% endif %}

{% block content %}<div id="content-main">
{% block object-tools %}
{% if change and not is_popup %}
  <ul class="object-tools">
    {% block object-tools-items %}
      {% change_form_object_tools %}
    {% endblock %}
  </ul>
{% endif %}
{% endblock %}
<form {% if has_file_field %}enctype="multipart/form-data" {% endif %}{% if form_url %}action="{{ form_url }}" {% endif %}method="post" id="{{ opts.model_name }}_form" novalidate>{% csrf_token %}{% block form_top %}{% endblock %}
<div>
{% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
{% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
{% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}
{% if errors %}
    <p class="errornote">
    {% blocktranslate count counter=errors|length %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktranslate %}
    </p>
    {{ adminform.form.non_field_errors }}
{% endif %}

{% block field_sets %}
{% for fieldset in adminform %}
  {% include "admin/includes/fieldset.html" with heading_level=2 prefix="fieldset" id_prefix=0 id_suffix=forloop.counter0 %}
{% endfor %}
{% endblock %}

{% block after_field_sets %}{% endblock %}

{% block inline_field_sets %}
{% for inline_admin_formset in inline_admin_formsets %}
    {% include inline_admin_formset.opts.template %}
{% endfor %}
{% endblock %}

{% block after_related_objects %}{% endblock %}

<!-- REPLACE BLOCK submit_buttons_bottom -->

<!-- Original block (Django) -->
{% comment %} % block submit_buttons_bottom %}{% submit_row %}{% endblock %} {% endcomment %}

<!-- NEW BLOCK (Dwarfs4MOSAIC) -->
<!-- Add button to open 'researcher' view -->
{% block submit_buttons_bottom %}
  {% submit_row %}
  {% if researcher_link %}
      <a href="{{ researcher_link }}" class="button" style="background-color:#417690; color:white; margin-left: 10px; padding: 9px 9px;">
        Open Researcher
      </a>
  {% endif %}
{% endblock %}

<!-- REPLACE BLOCK submit_buttons_bottom (end) -->

{% block admin_change_form_document_ready %}
    <script id="django-admin-form-add-constants"
            src="{% static 'admin/js/change_form.js' %}"
            {% if adminform and add %}
                data-model-name="{{ opts.model_name }}"
            {% endif %}
            async>
    </script>
{% endblock %}

{# JavaScript for prepopulated fields #}
{% prepopulated_fields_js %}

</div>
</form></div>
{% endblock %}
